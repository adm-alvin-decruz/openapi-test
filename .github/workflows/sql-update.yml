name: sql-update-action
run-name: ${{ github.event.inputs.sql-environment }} Sql Update. Job ${{ github.job }} started by ${{ github.actor }}
on:
  workflow_dispatch:
    inputs:
      sql-environment:
        type: environment
        description: Select the environment
      sql-script-path:
        description: "Full absolute path to SQL script"
        required: true
        type: string
jobs:
  sql-update-with-backup:
    runs-on: commonservices-${{ github.event.inputs.sql-environment }}
    environment: ${{ github.event.inputs.sql-environment }}
    steps:
      - name: checkout Repo
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1
          role-to-assume: ${{ secrets.role_arn }}
          role-external-id: ${{ secrets.external_id }}
          role-skip-session-tagging: true
      - name: Set Dynamic Database Env Variables
        id: set-db-env
        run: |
          # Retrieve RDS Cluster information
          DB_SERVER_ENDPOINT=$(aws rds describe-db-cluster-endpoints --db-cluster-identifier ciam-${{ github.event.inputs.sql-environment }} --query 'DBClusterEndpoints[*].[Endpoint]' --filters 'Name=db-cluster-endpoint-type,Values=writer' --output text)
          DB_USERNAME=$(aws secretsmanager get-secret-value --secret-id ciam-${{ github.event.inputs.sql-environment }}-db-user1 --query 'SecretString' --output text|jq -r .db_user)
          DB_PASSWORD=$(aws secretsmanager get-secret-value --secret-id ciam-${{ github.event.inputs.sql-environment }}-db-user1 --query 'SecretString' --output text|jq -r .db_password)

        echo "::add-mask::$DB_PASSWORD"
          
          # Set Values as environment variables
          {
            echo "DB_SERVER_ENDPOINT=$DB_SERVER_ENDPOINT"
            echo "DB_USERNAME=$DB_USERNAME"
            echo "DB_PASSWORD=$DB_PASSWORD"
          } >> $GITHUB_ENV
      - name: Create and Verify Backup
        id: backup
        env:
          TZ: Asia/Singapore
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_SERVER_ENDPOINT: ${{ env.DB_SERVER_ENDPOINT }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
        run: |
          mkdir ./backups
          echo "TIMESTAMP=$(date +%d%m%y-%H%M%S)" >> "$GITHUB_ENV"
          BACKUP_FILE="./backups/mfa-${{ github.event.inputs.sql-environment }}-mysql-backup-$TIMESTAMP.sql.gz"
          
          # Create a temporary file for mysqldump errors
          ERROR_LOG=$(mktemp)
          # Run mysqldump with all specified parameters and capture both output and errors
          if ! mysqldump -h "$DB_SERVER_ENDPOINT" -P 3306 --ssl -u "$DB_USERNAME" -p$DB_PASSWORD \
            --single-transaction --routines --triggers -B ciam -y 2>"$ERROR_LOG" | gzip > "$BACKUP_FILE"; then
            echo "mysqldump failed with error:"
            cat "$ERROR_LOG"
            rm "$ERROR_LOG"
            exit 1
          fi
          # Check for any errors in the error log
          if [ -s "$ERROR_LOG" ]; then
            echo "mysqldump reported errors:"
            cat "$ERROR_LOG"
            rm "$ERROR_LOG"
            exit 1
          fi
          # Remove error log
          rm "$ERROR_LOG"
          # Verify backup file exists and is not empty
          if [ ! -s "$BACKUP_FILE" ]; then
            echo "Backup file is empty. Terminating job."
            exit 1
          fi
          # Verify backup file can be read
          if ! gzip -t "$BACKUP_FILE"; then
            echo "Backup file is corrupted. Terminating job."
            exit 1
          fi
          echo "backup_created=true" >> $GITHUB_OUTPUT
      - name: Upload Backup as Artifacts
        id: upload-backup
        if: steps.backup.outputs.backup_created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ciam-rds-backup
          path: ./backups
          retention-days: 14
      - name: Run SQL Update
        if: steps.backup.outputs.backup_created == 'true' && steps.upload-backup.conclusion == 'success'
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_SERVER_ENDPOINT: ${{ env.DB_SERVER_ENDPOINT }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
        run: |
          echo "list all databases"
          mysql -h "$DB_SERVER_ENDPOINT" -P 3306 --ssl -u "$DB_USERNAME" -p$DB_PASSWORD -e "SHOW DATABASES;"
          echo "running ${{ github.event.inputs.sql-script-path }}"
          mysql -h "$DB_SERVER_ENDPOINT" -P 3306 --ssl -u "$DB_USERNAME" -p$DB_PASSWORD -D ciam < ${{ github.event.inputs.sql-script-path }}
<<<<<<< HEAD
=======

>>>>>>> 426b60932be2ae2284506e853b701183604d79ef
      - name: Verify Deployment
        if: steps.backup.outputs.backup_created == 'true' && steps.upload-backup.conclusion == 'success'
        run: echo "Run Query to verify db update/rollback of database/table is successful"
