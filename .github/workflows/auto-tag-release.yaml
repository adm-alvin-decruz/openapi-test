name: Auto Tag and Release

on:
  workflow_dispatch:
    branches:
      - "releases/*"
      - "pr/releases/*"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version, Tag, and Flags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          GITHUB_REPO=${{ github.repository }}

          if [[ "$BRANCH_NAME" == pr/releases/* ]]; then
            BASE_VERSION="${BRANCH_NAME#pr/releases/}"

            EXISTING_TAGS=$(git tag -l "v${BASE_VERSION}-rc.*" | sort -V)
            LAST_RC=0
            for tag in $EXISTING_TAGS; do
              NUM=${tag##*-rc.}
              [[ $NUM =~ ^[0-9]+$ ]] && LAST_RC=$NUM
            done
            NEXT_RC=$((LAST_RC + 1))
            NEW_VERSION="v${BASE_VERSION}-rc.${NEXT_RC}"

            echo "PRERELEASE=true" >> $GITHUB_ENV
            echo "DRAFT=true" >> $GITHUB_ENV

          elif [[ "$BRANCH_NAME" == releases/* ]]; then
            BASE_VERSION="${BRANCH_NAME#releases/}"
            NEW_VERSION="v${BASE_VERSION}"

            if [[ "$BASE_VERSION" == *"-"* ]]; then
              echo "PRERELEASE=true" >> $GITHUB_ENV
              echo "DRAFT=true" >> $GITHUB_ENV
              echo "USE_RC_NOTES=false" >> $GITHUB_ENV
            else
              # ‚úÖ Safe check for matching RC tag
              MATCHING_RC=$(git tag -l "v${BASE_VERSION}-rc.*" | sort -V | tail -n1)

              if [[ -n "$MATCHING_RC" ]]; then
                echo "Found matching RC tag: $MATCHING_RC"

                RC_COMMIT=$(git rev-list -n 1 "$MATCHING_RC")
                CURRENT_COMMIT=$(git rev-parse HEAD)

                echo "RC commit: $RC_COMMIT"
                echo "Current commit: $CURRENT_COMMIT"

                if [[ "$RC_COMMIT" == "$CURRENT_COMMIT" ]]; then
                  echo "USE_RC_NOTES=true" >> $GITHUB_ENV
                  echo "PROMOTE_RC_TAG=$MATCHING_RC" >> $GITHUB_ENV
                else
                  echo "USE_RC_NOTES=false" >> $GITHUB_ENV
                fi
              else
                echo "No matching RC tag found for $BASE_VERSION"
                echo "USE_RC_NOTES=false" >> $GITHUB_ENV
              fi

              echo "PRERELEASE=false" >> $GITHUB_ENV
              echo "DRAFT=true" >> $GITHUB_ENV
            fi
          fi

          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Generate CHANGELOG.md (safe loops, flat PR list)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          GITHUB_REPO=${{ github.repository }}
          CURRENT_DATE=$(date +'%Y-%m-%d')
          VERSION_LINK="[${NEW_VERSION}](https://github.com/$GITHUB_REPO/releases/tag/${NEW_VERSION})"
          HEADER="# $VERSION_LINK ‚Äì $CURRENT_DATE"
          TEMP_CHANGELOG="changelog_body.tmp"
          > "$TEMP_CHANGELOG"

          echo "üì¶ Fetching merged PRs targeting base: ${GITHUB_REF_NAME}"
          MERGED_PRS=$(gh pr list \
            --state merged \
            --search "base:${GITHUB_REF_NAME}" \
            --limit 100 \
            --json number,title,author,mergeCommit \
            2>/dev/null || echo "[]")

          if [[ -z "$MERGED_PRS" || "$MERGED_PRS" == "[]" ]]; then
            echo "$HEADER" > CHANGELOG.md
            echo -e "\n_No pull requests merged to this branch. Checking Direct Commits"
          else

          while read -r row; do
            PR_NUMBER=$(echo "$row" | jq -r '.number')
            PR_TITLE=$(echo "$row" | jq -r '.title' | tr '\n' ' ')
            PR_AUTHOR=$(echo "$row" | jq -r '.author.login')
            PR_URL="https://github.com/$GITHUB_REPO/pull/$PR_NUMBER"

            echo "üîç Processing PR #$PR_NUMBER..."

            LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>/dev/null | xargs -n1 | sed 's/^/`/' | sed 's/$/`/' | paste -sd' ' -)

            PR_COMMITS_JSON=$(gh pr view "$PR_NUMBER" --json commits 2>/dev/null || echo "")
            if [[ -z "$PR_COMMITS_JSON" || "$PR_COMMITS_JSON" == "[]" ]]; then
              echo "‚ö†Ô∏è Skipping PR #$PR_NUMBER: No commits found or failed to fetch"
              continue
            fi

            PR_COMMITS=$(echo "$PR_COMMITS_JSON" | jq '.commits')
            PR_COMMIT_COUNT=$(echo "$PR_COMMITS" | jq length)

            REACHABLE=false
            while read -r commit; do
              if git merge-base --is-ancestor "$commit" HEAD; then
                REACHABLE=true
                break
              fi
            done <<< "$(echo "$PR_COMMITS" | jq -r '.[].oid')"

            [[ "$REACHABLE" != "true" ]] && echo "‚è≠Ô∏è Skipping PR #$PR_NUMBER ‚Äî not in HEAD" && continue

            PR_LINE="- **PR:** $PR_TITLE ([#${PR_NUMBER}]($PR_URL) by @$PR_AUTHOR)"
            [[ -n "$LABELS" ]] && PR_LINE+=" $LABELS"
            echo "$PR_LINE" >> "$TEMP_CHANGELOG"

            if (( PR_COMMIT_COUNT > 5 )); then
              echo "<details><summary>Commits ($PR_COMMIT_COUNT)</summary>" >> "$TEMP_CHANGELOG"
              echo >> "$TEMP_CHANGELOG"
            else
              echo -e "  Commits:" >> "$TEMP_CHANGELOG"
            fi

            while read -r commit; do
              COMMIT_SHA=$(echo "$commit" | jq -r '.oid')
              [[ -z "$COMMIT_SHA" ]] && continue
              COMMIT_MSG=$(git show -s --format='%s' "$COMMIT_SHA")
              COMMIT_URL="https://github.com/$GITHUB_REPO/commit/$COMMIT_SHA"
              COMMIT_AUTHOR=$(git show -s --format='%an' "$COMMIT_SHA")
              COMMIT_DATE=$(git show -s --format='%ad' --date=short "$COMMIT_SHA")
              echo -e "\t- [$COMMIT_SHA]($COMMIT_URL) $COMMIT_MSG ($COMMIT_AUTHOR, $COMMIT_DATE)" >> "$TEMP_CHANGELOG"
            done <<< "$(echo "$PR_COMMITS" | jq -c '.[]')"

            (( PR_COMMIT_COUNT > 5 )) && echo "</details>" >> "$TEMP_CHANGELOG"
            echo >> "$TEMP_CHANGELOG"
          done <<< "$(echo "$MERGED_PRS" | jq -c '.[]')"
          fi

          # ‚ûï Include direct commits not part of PRs
          git log --pretty=format:'%H' origin/main..HEAD > all_commits.txt
          cat all_commits.txt
          grep -oP '(?<=\[)[a-f0-9]{7,40}(?=\])' "$TEMP_CHANGELOG" | sort -u > pr_commits.txt
          cat pr_commits.txt
          grep -vxFf pr_commits.txt all_commits.txt > direct_commits.txt

          if [[ -s direct_commits.txt ]]; then
            echo -e "- **Direct Commits:**" >> "$TEMP_CHANGELOG"
            while read -r commit; do
              COMMIT_MSG=$(git show -s --format='%s' "$commit")
              COMMIT_AUTHOR=$(git show -s --format='%an' "$commit")
              COMMIT_DATE=$(git show -s --format='%ad' --date=short "$commit")
              COMMIT_URL="https://github.com/$GITHUB_REPO/commit/$commit"
              echo -e "\t- [$commit]($COMMIT_URL) $COMMIT_MSG ($COMMIT_AUTHOR, $COMMIT_DATE)" >> "$TEMP_CHANGELOG"
            done < direct_commits.txt
            echo >> "$TEMP_CHANGELOG"
          fi
  
          {
            echo "$HEADER"
            echo
            if [[ -s "$TEMP_CHANGELOG" ]]; then
              cat "$TEMP_CHANGELOG"
            else
              echo "_No qualifying pull requests and Direct commits found in this release._"
            fi
            [[ "$USE_RC_NOTES" == "true" ]] && echo -e "\n_Promoted from [$PROMOTE_RC_TAG](https://github.com/$GITHUB_REPO/releases/tag/$PROMOTE_RC_TAG)_"
          } > CHANGELOG.md

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          cat CHANGELOG.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Git Tag
        run: |
          git tag "$NEW_VERSION"
          git push origin "$NEW_VERSION"

#      - name: Commit & Push CHANGELOG.md to Repo
#        run: |
#          cat CHANGELOG.md
#          git config user.name "github-actions[bot]"
#          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
#          git add CHANGELOG.md
#          git commit -m "docs: update CHANGELOG.md for $NEW_VERSION"
#          git push origin ${{ github.ref_name }}

      - name: Create GitHub Release with Changelog
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_VERSION }}
          name: "Release ${{ env.NEW_VERSION }}"
          body: |
            ${{ env.RELEASE_NOTES }}
          draft: ${{ env.DRAFT }}
          prerelease: ${{ env.PRERELEASE }}
          files: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
